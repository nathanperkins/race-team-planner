generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String         @unique
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  expectationsVersion Int            @default(0)
  iracingCustomerId   String?
  role                UserRole       @default(USER)
  accounts            Account[]
  registrations       Registration[]
  racerStats          RacerStats[]
}

enum UserRole {
  USER
  ADMIN
}

model RacerStats {
  id            String   @id @default(cuid())
  userId        String
  categoryId    Int
  category      String
  irating       Int
  licenseLevel  Int
  licenseGroup  Int
  safetyRating  Float
  cpi           Float
  ttRating      Int
  mprNumRaces   Int
  color         String
  groupName     String
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  /// @encrypted
  refresh_token     String?
  /// @encrypted
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  /// @encrypted
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Event {
  id          String     @id @default(cuid())
  name        String
  /// Derived from the earliest Race
  startTime   DateTime
  track       String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  externalId  String?    @unique
  /// Derived from the latest Race
  endTime     DateTime
  licenseGroup Int?
  tempValue     Int?
  tempUnits     Int?
  relHumidity   Int?
  skies         Int?
  precipChance  Int?
  durationMins  Int?       /// In minutes
  races       Race[]
  carClasses  CarClass[] @relation("CarClassToEvent")
}

model Race {
  id            String         @id @default(cuid())
  externalId    String?        @unique
  startTime     DateTime
  endTime       DateTime
  eventId       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  event         Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrations Registration[]

  @@unique([eventId, startTime])
}

model Registration {
  id         String   @id @default(cuid())
  userId     String
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  raceId     String
  carClassId String
  carClass   CarClass @relation(fields: [carClassId], references: [id])
  race       Race     @relation(fields: [raceId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, raceId])
}

model CarClass {
  id            String         @id @default(cuid())
  externalId    Int            @unique
  name          String
  shortName     String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  registrations Registration[]
  events        Event[]        @relation("CarClassToEvent")
}
