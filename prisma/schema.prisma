generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String         @unique
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  expectationsVersion Int            @default(0)
  role                UserRole       @default(USER)
  iracingName         String?
  onboardedAnnounced  Boolean        @default(false)
  iracingCustomerId   Int?           @unique
  accounts            Account[]
  racerStats          RacerStats[]
  registrations       Registration[]
  teams               Team[]         @relation("UserTeams")
}

model RacerStats {
  id           String   @id @default(cuid())
  userId       String
  categoryId   Int
  category     String
  irating      Int
  licenseLevel Int
  licenseGroup Int
  safetyRating Float
  cpi          Float
  ttRating     Int
  mprNumRaces  Int
  color        String
  groupName    String
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  /// @encrypted
  refresh_token     String?
  /// @encrypted
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  /// @encrypted
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Event {
  id               String     @id @default(cuid())
  name             String
  /// Derived from the earliest Race
  startTime        DateTime
  track            String
  description      String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  externalId       String?    @unique
  /// Derived from the latest Race
  endTime          DateTime
  licenseGroup     Int?
  relHumidity      Int?
  skies            Int?
  tempUnits        Int?
  tempValue        Int?
  /// In minutes
  durationMins     Int?
  precipChance     Int?
  /// e.g., "Grand Prix", "Road Course"
  trackConfig      String?
  /// For custom events, user-typed car class names
  customCarClasses String[]
  races            Race[]
  carClasses       CarClass[] @relation("CarClassToEvent")
}

model Race {
  id            String         @id @default(cuid())
  externalId    String?        @unique
  startTime     DateTime
  endTime       DateTime
  teamsAssigned Boolean        @default(false)
  discordTeamsThreadId String?
  discordTeamsSnapshot Json?
  discordTeamThreads Json?
  maxDriversPerTeam Int?
  teamAssignmentStrategy TeamAssignmentStrategy @default(BALANCED_IRATING)
  eventId       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  event         Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrations Registration[]

  @@unique([eventId, startTime])
}

enum TeamAssignmentStrategy {
  BALANCED_IRATING
}

model Registration {
  id             String        @id @default(cuid())
  userId         String?
  manualDriverId String?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  raceId         String
  carClassId     String
  teamId         String?
  carClass       CarClass      @relation(fields: [carClassId], references: [id])
  manualDriver   ManualDriver? @relation(fields: [manualDriverId], references: [id])
  race           Race          @relation(fields: [raceId], references: [id], onDelete: Cascade)
  team           Team?         @relation(fields: [teamId], references: [id])
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, raceId])
  @@unique([manualDriverId, raceId])
}

model ManualDriver {
  id            String         @id @default(cuid())
  name          String
  image         String
  irating       Int            @default(1350)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  registrations Registration[]
}

model CarClass {
  id            String         @id @default(cuid())
  externalId    Int            @unique
  name          String
  shortName     String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  registrations Registration[]
  events        Event[]        @relation("CarClassToEvent")
}

model SyncLog {
  id        String     @id @default(cuid())
  startTime DateTime   @default(now())
  endTime   DateTime?
  status    SyncStatus
  error     String?
  source    SyncSource @default(MANUAL)
  count     Int?
}

model Team {
  id            String           @id @default(cuid())
  name          String           @unique
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  iracingTeamId Int              @unique
  registrations Registration[]
  roles         TeamMemberRole[]
  teamMembers   TeamMember[]     @relation("TeamToTeamMember")
  members       User[]           @relation("UserTeams")
}

model TeamMember {
  id          String           @id @default(cuid())
  custId      Int              @unique
  displayName String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       TeamMemberRole[]
  teams       Team[]           @relation("TeamToTeamMember")

  @@index([custId])
}

model TeamMemberRole {
  id           String     @id @default(cuid())
  teamMemberId String
  teamId       String
  isOwner      Boolean    @default(false)
  isAdmin      Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, teamId])
  @@index([teamId])
}

enum UserRole {
  USER
  ADMIN
}

enum SyncStatus {
  SUCCESS
  FAILURE
  IN_PROGRESS
}

enum SyncSource {
  MANUAL
  CRON
}
